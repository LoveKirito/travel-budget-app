<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>旅遊預算管理</title>
    <meta name="description" content="智慧管理你的旅遊支出">
    <meta name="theme-color" content="#3B82F6">
    
    <!-- PWA 設定 -->
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIuaXhemggumlseeulOeuoeePhumpr+eoi+WPs+OAiSIsCiAgInNob3J0X25hbWUiOiAi5peF6YCS6aW554GMCII7LAogICJkZXNjcmlwdGlvbiI6ICLmmarisZTnrqHnkIbkvaDnmoTml4XpgJLmlK/lh7oCTAogICJzdGFydF91cmwiOiAiLiIsCiAgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIsCiAgImJhY2tncm91bmRfY29sb3IiOiAiI0ZGRkZGRiIsCiAgInRoZW1lX2NvbG9yIjogIiMzQjgyRjYiLAogICJpY29ucyI6IFsKICAgIHsKICAgICAgInNyYyI6ICJkYXRhOmltYWdlL3N2Zyt4bWw7YmFzZTY0LFBITjJaeUI0Yld4dWN6MGlhSFIwY0RvdkwzZDNkeTUzTXk1dmNtY3ZNakF3TUM5emRtY2lJSGRwWkhSb1BTSXhOalFpSUdobGFXZG9kRDBpTVRZMElpQjJhV1YzUW05NFBTSXVJAKPS2J3SUlsNnUi0xzNGpKKvzTZ5KhbQUvqSTcgPFLmSIGZlUtAYUeS1MbElQeYSEv0laNMrVqyJJ1lgotMjM1ZUJwWlNXUjlwVXpZOEJzZGI3enB0M1hHWWZETFNMjEwQBAgpAZAa4BCAc0N6W1A4BFHUU4eEI2QLgEHU2PAS2gE1MhgZWEt4FaRODk3UUJLW6FfnQ2N4V1U9MhgZVTcxe1QUYNtUNVAIKVg5NGUULjWEd1RHWJBDcyolSJlGU1BwwUJlWTUNb0E1TYN1gVsUMOFZAZAUFGGEgb2L2I1QvAQR="
ICAgICAgInNpemVzIjogIjE5MmgxOTIiLAogICAgICAidHlwZSI6ICJpbWFnZS9wbmciCiAgICB9LAogICAgewogICAgICAic3JjIjogImRhdGE6aW1hZ2Uvc3ZnK3htbDtiYXNlNjQsUEhOMlp5QjRiV3h1Y3owOFIZWEhmSWNpcExYZDNkeTUzTXk1dmNtY3ZNakF3TUM5emRtY2lJSGRwWkhSb1BTSXpOVFlpSUdobGFXZG9kRDBpTXpVMklpQjJhV1YzUW05NFBTSXVJAKNS2J3SUlsNnUi0xzNGpKKvzTZ5KhbQUvqSTcgPFLmSIGZlUtAYUeS1MbElQeYSEv0laNMrVqyJJ1lgotMjM1ZUJwWlNXUjlwVXpZOEJzZGI3enB0M1hHWWZETFNMjEwQBAgpAZAa4BCAc0N6W1A4BFHUU4eEI2QLgEHU2PAS2gE1MhgZWEt4FaRODk3UUJLW6FfnQ2N4V1U9MhgZVTcxe1QUYNtUNVAIKVg5NGUULjWEd1RHWJBDcyolSJlGU1BwwUJlWTUNb0E1TYN1gVsUMOFZAZAUFGGEgb2L2I1QvAQR="
ICAgICAgInNpemVzIjogIjUxMng1MTIiLAogICAgICAidHlwZSI6ICJpbWFnZS9wbmciCiAgICB9CiAgXQp9">
    
    <!-- Service Worker 註冊 -->
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('data:application/javascript;base64,c2VsZi5hZGRFdmVudExpc3RlbmVyKCdpbnN0YWxsJywgZXZlbnQgPT4gewogIGNvbnNvbGUubG9nKCdTZXJ2aWNlIFdvcmtlciBpbnN0YWxsZWQnKTsKfSk7CgpzZWxmLmFkZEV2ZW50TGlzdGVuZXIoJ2ZldGNoJywgZXZlbnQgPT4gewogIC8vIEJhc2ljIGZldGNoIGhhbmRsaW5nCiAgZXZlbnQucmVzcG9uZFdpdGgoZmV0Y2goZXZlbnQucmVxdWVzdCkpOwp9KTs=')
                .then(registration => console.log('SW registered'))
                .catch(error => console.log('SW registration failed'));
        }
    </script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.22.5/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        body { margin: 0; padding: 0; font-family: system-ui, -apple-system, sans-serif; }
        .install-prompt {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #3B82F6;
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            display: none;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <!-- 安裝提示 -->
    <div id="install-prompt" class="install-prompt">
        <button onclick="installApp()">📱 安裝到桌面</button>
        <button onclick="dismissInstall()" style="margin-left: 10px; background: none; border: none; color: white;">✕</button>
    </div>

    <script type="text/babel">
        const { useState } = React;
        
        // Lucide React Icons (simplified)
        const PlusCircle = () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><path d="M12 8v8M8 12h8"/></svg>;
        const Trash2 = () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M3 6h18M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>;
        const AlertTriangle = () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>;
        const Wallet = () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 12V7H5a2 2 0 0 1 0-4h14v4"/><path d="M3 5v14a2 2 0 0 0 2 2h16v-5"/><line x1="18" y1="12" x2="18" y2="12"/></svg>;
        const TrendingDown = () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="23 18 13.5 8.5 8.5 13.5 1 6"/><polyline points="17 18 23 18 23 12"/></svg>;
        const RotateCcw = () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/></svg>;
        const Download = () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>;
        const Upload = () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>;

        function TravelBudgetApp() {
            const [totalBudget, setTotalBudget] = useState(() => {
                const saved = localStorage.getItem('travelBudget');
                return saved ? JSON.parse(saved).totalBudget || 0 : 0;
            });
            
            const [expenses, setExpenses] = useState(() => {
                const saved = localStorage.getItem('travelBudget');
                return saved ? JSON.parse(saved).expenses || [] : [];
            });
            
            const [newExpense, setNewExpense] = useState({
                description: '',
                amount: '',
                category: '餐飲'
            });

            const categories = ['餐飲', '住宿', '交通', '購物', '娛樂', '其他'];
            
            // 自動保存到 localStorage
            React.useEffect(() => {
                const data = { totalBudget, expenses };
                localStorage.setItem('travelBudget', JSON.stringify(data));
            }, [totalBudget, expenses]);
            
            const totalSpent = expenses.reduce((sum, expense) => sum + expense.amount, 0);
            const remainingBudget = totalBudget - totalSpent;
            const budgetUsedPercentage = totalBudget > 0 ? (totalSpent / totalBudget) * 100 : 0;

            const addExpense = () => {
                if (newExpense.description && newExpense.amount) {
                    const expense = {
                        id: Date.now(),
                        description: newExpense.description,
                        amount: parseFloat(newExpense.amount),
                        category: newExpense.category,
                        date: new Date().toLocaleDateString('zh-TW')
                    };
                    setExpenses([...expenses, expense]);
                    setNewExpense({ description: '', amount: '', category: '餐飲' });
                }
            };

            const deleteExpense = (id) => {
                setExpenses(expenses.filter(exp => exp.id !== id));
            };

            const clearAllData = () => {
                if (window.confirm('確定要清除所有資料嗎？此操作無法復原！')) {
                    setTotalBudget(0);
                    setExpenses([]);
                    setNewExpense({ description: '', amount: '', category: '餐飲' });
                    localStorage.removeItem('travelBudget');
                }
            };

            const exportData = () => {
                const data = {
                    totalBudget,
                    expenses,
                    exportDate: new Date().toISOString(),
                    version: '1.0'
                };
                
                const dataStr = JSON.stringify(data, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = `旅遊預算_${new Date().toLocaleDateString('zh-TW').replace(/\//g, '')}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            };

            const importData = (event) => {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        
                        if (data.totalBudget !== undefined && Array.isArray(data.expenses)) {
                            if (window.confirm('匯入資料將覆蓋目前的所有資料，確定要繼續嗎？')) {
                                setTotalBudget(data.totalBudget || 0);
                                setExpenses(data.expenses || []);
                                alert('資料匯入成功！');
                            }
                        } else {
                            alert('檔案格式不正確！');
                        }
                    } catch (error) {
                        alert('檔案讀取失敗，請確認檔案格式正確！');
                    }
                };
                reader.readAsText(file);
                event.target.value = '';
            };

            const getCategoryTotal = (category) => {
                return expenses
                    .filter(exp => exp.category === category)
                    .reduce((sum, exp) => sum + exp.amount, 0);
            };

            const getWarningLevel = () => {
                if (budgetUsedPercentage >= 90) return 'danger';
                if (budgetUsedPercentage >= 75) return 'warning';
                return 'safe';
            };

            const warningConfig = {
                danger: { color: 'text-red-600', bg: 'bg-red-50', border: 'border-red-200' },
                warning: { color: 'text-yellow-600', bg: 'bg-yellow-50', border: 'border-yellow-200' },
                safe: { color: 'text-green-600', bg: 'bg-green-50', border: 'border-green-200' }
            };

            const currentWarning = warningConfig[getWarningLevel()];

            return (
                <div className="max-w-md mx-auto bg-white min-h-screen">
                    {/* Header */}
                    <div className="bg-gradient-to-r from-blue-500 to-purple-600 text-white p-6">
                        <div className="flex items-center gap-2 mb-2">
                            <Wallet />
                            <h1 className="text-xl font-bold">旅遊預算管理</h1>
                        </div>
                        <p className="text-blue-100 text-sm">智慧管理你的旅遊支出</p>
                    </div>

                    <div className="p-4 space-y-6">
                        {/* Budget Setting */}
                        <div className="bg-gray-50 rounded-lg p-4">
                            <label className="block text-sm font-medium text-gray-700 mb-2">
                                設定總預算 (新台幣)
                            </label>
                            <input
                                type="number"
                                value={totalBudget || ''}
                                onChange={(e) => setTotalBudget(parseFloat(e.target.value) || 0)}
                                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                placeholder="輸入你的總預算"
                            />
                        </div>

                        {/* Budget Overview */}
                        {totalBudget > 0 && (
                            <div className={`rounded-lg p-4 border ${currentWarning.border} ${currentWarning.bg}`}>
                                <div className="flex items-center gap-2 mb-3">
                                    {budgetUsedPercentage >= 75 && <AlertTriangle />}
                                    <h3 className="font-semibold text-gray-800">預算總覽</h3>
                                </div>
                                
                                <div className="space-y-2">
                                    <div className="flex justify-between text-sm">
                                        <span>總預算：</span>
                                        <span className="font-medium">NT${totalBudget.toLocaleString()}</span>
                                    </div>
                                    <div className="flex justify-between text-sm">
                                        <span>已支出：</span>
                                        <span className="font-medium">NT${totalSpent.toLocaleString()}</span>
                                    </div>
                                    <div className="flex justify-between text-sm">
                                        <span>剩餘：</span>
                                        <span className={`font-medium ${remainingBudget < 0 ? 'text-red-600' : 'text-green-600'}`}>
                                            NT${remainingBudget.toLocaleString()}
                                        </span>
                                    </div>
                                </div>

                                {/* Progress Bar */}
                                <div className="mt-3">
                                    <div className="flex justify-between text-xs text-gray-600 mb-1">
                                        <span>預算使用率</span>
                                        <span>{budgetUsedPercentage.toFixed(1)}%</span>
                                    </div>
                                    <div className="w-full bg-gray-200 rounded-full h-2">
                                        <div 
                                            className={`h-2 rounded-full transition-all duration-300 ${
                                                budgetUsedPercentage >= 90 ? 'bg-red-500' : 
                                                budgetUsedPercentage >= 75 ? 'bg-yellow-500' : 'bg-green-500'
                                            }`}
                                            style={{ width: `${Math.min(budgetUsedPercentage, 100)}%` }}
                                        />
                                    </div>
                                </div>

                                {budgetUsedPercentage >= 75 && (
                                    <div className={`mt-3 text-sm ${currentWarning.color}`}>
                                        {budgetUsedPercentage >= 90 ? 
                                            '⚠️ 預算即將用完，請控制支出！' : 
                                            '⚠️ 預算使用率較高，請注意控制支出'
                                        }
                                    </div>
                                )}
                            </div>
                        )}

                        {/* Data Management */}
                        <div className="bg-gray-50 rounded-lg p-4">
                            <h3 className="font-semibold text-gray-800 mb-3">資料管理</h3>
                            
                            <div className="grid grid-cols-2 gap-2">
                                <button
                                    onClick={exportData}
                                    className="flex items-center justify-center gap-2 bg-green-500 text-white p-2 rounded-lg hover:bg-green-600 transition-colors text-sm"
                                >
                                    <Download />
                                    匯出紀錄
                                </button>
                                
                                <label className="flex items-center justify-center gap-2 bg-blue-500 text-white p-2 rounded-lg hover:bg-blue-600 transition-colors text-sm cursor-pointer">
                                    <Upload />
                                    匯入紀錄
                                    <input
                                        type="file"
                                        accept=".json"
                                        onChange={importData}
                                        className="hidden"
                                    />
                                </label>
                            </div>
                            
                            <button
                                onClick={clearAllData}
                                className="w-full mt-2 flex items-center justify-center gap-2 bg-red-500 text-white p-2 rounded-lg hover:bg-red-600 transition-colors text-sm"
                            >
                                <RotateCcw />
                                清除所有資料
                            </button>
                        </div>

                        {/* Add Expense */}
                        <div className="bg-gray-50 rounded-lg p-4">
                            <h3 className="font-semibold text-gray-800 mb-3">新增支出</h3>
                            
                            <div className="space-y-3">
                                <input
                                    type="text"
                                    value={newExpense.description}
                                    onChange={(e) => setNewExpense({...newExpense, description: e.target.value})}
                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                    placeholder="支出描述 (如：午餐、計程車費)"
                                />
                                
                                <div className="flex gap-2">
                                    <input
                                        type="number"
                                        value={newExpense.amount}
                                        onChange={(e) => setNewExpense({...newExpense, amount: e.target.value})}
                                        className="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                        placeholder="金額"
                                    />
                                    
                                    <select
                                        value={newExpense.category}
                                        onChange={(e) => setNewExpense({...newExpense, category: e.target.value})}
                                        className="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                    >
                                        {categories.map(cat => (
                                            <option key={cat} value={cat}>{cat}</option>
                                        ))}
                                    </select>
                                </div>
                                
                                <button
                                    onClick={addExpense}
                                    className="w-full bg-blue-500 text-white p-3 rounded-lg hover:bg-blue-600 transition-colors flex items-center justify-center gap-2"
                                >
                                    <PlusCircle />
                                    新增支出
                                </button>
                            </div>
                        </div>

                        {/* Category Summary */}
                        {expenses.length > 0 && (
                            <div className="bg-gray-50 rounded-lg p-4">
                                <h3 className="font-semibold text-gray-800 mb-3">分類統計</h3>
                                <div className="grid grid-cols-2 gap-2">
                                    {categories.map(category => {
                                        const categoryTotal = getCategoryTotal(category);
                                        if (categoryTotal === 0) return null;
                                        return (
                                            <div key={category} className="bg-white p-2 rounded border text-sm">
                                                <div className="font-medium">{category}</div>
                                                <div className="text-blue-600">NT${categoryTotal.toLocaleString()}</div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        )}

                        {/* Expense List */}
                        {expenses.length > 0 && (
                            <div className="space-y-3">
                                <h3 className="font-semibold text-gray-800 flex items-center gap-2">
                                    <TrendingDown />
                                    支出記錄
                                </h3>
                                
                                {expenses.slice().reverse().map(expense => (
                                    <div key={expense.id} className="bg-white border border-gray-200 rounded-lg p-3">
                                        <div className="flex justify-between items-start">
                                            <div className="flex-1">
                                                <div className="font-medium text-gray-800">{expense.description}</div>
                                                <div className="text-sm text-gray-500 flex gap-3">
                                                    <span>{expense.category}</span>
                                                    <span>{expense.date}</span>
                                                </div>
                                            </div>
                                            <div className="flex items-center gap-2">
                                                <span className="font-semibold text-red-600">
                                                    -NT${expense.amount.toLocaleString()}
                                                </span>
                                                <button
                                                    onClick={() => deleteExpense(expense.id)}
                                                    className="text-red-500 hover:text-red-700 p-1"
                                                >
                                                    <Trash2 />
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}

                        {expenses.length === 0 && totalBudget > 0 && (
                            <div className="text-center py-8 text-gray-500">
                                <Wallet />
                                <p>還沒有支出記錄</p>
                                <p className="text-sm">開始記錄你的第一筆支出吧！</p>
                            </div>
                        )}

                        {/* PWA Notice */}
                        <div className="bg-blue-50 border border-blue-200 rounded-lg p-3 text-sm">
                            <div className="flex items-start gap-2">
                                <div className="text-blue-700">
                                    <p className="font-medium">📱 PWA版本優勢</p>
                                    <p className="text-xs mt-1">
                                        • 可安裝到桌面，像原生App一樣使用<br/>
                                        • 資料自動保存到手機存儲<br/>
                                        • 支援離線使用
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<TravelBudgetApp />, document.getElementById('root'));
    </script>

    <script>
        // PWA 安裝邏輯
        let deferredPrompt;
        const installPrompt = document.getElementById('install-prompt');
        
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            installPrompt.style.display = 'block';
        });

        function installApp() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('PWA 安裝成功');
                    }
                    deferredPrompt = null;
                    installPrompt.style.display = 'none';
                });
            }
        }

        function dismissInstall() {
            installPrompt.style.display = 'none';
        }

        // 安裝後隱藏提示
        window.addEventListener('appinstalled', () => {
            installPrompt.style.display = 'none';
            console.log('PWA 已安裝');
        });
    </script>
</body>
</html>
