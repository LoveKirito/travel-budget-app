<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—…éŠé ç®—ç®¡ç†</title>
    <meta name="theme-color" content="#3B82F6">
    
    <!-- Enhanced PWA Manifest for Widget-like experience -->
    <link rel="manifest" href="data:application/json;charset=utf-8,%7B%22name%22%3A%22%E6%97%85%E9%81%8A%E9%A0%90%E7%AE%97%E7%AE%A1%E7%90%86%22%2C%22short_name%22%3A%22%E9%A0%90%E7%AE%97%22%2C%22start_url%22%3A%22.%22%2C%22display%22%3A%22standalone%22%2C%22background_color%22%3A%22%23FFFFFF%22%2C%22theme_color%22%3A%22%233B82F6%22%2C%22shortcuts%22%3A%5B%7B%22name%22%3A%22%F0%9F%92%B0%20%E9%A0%90%E7%AE%97%E6%A6%82%E8%A6%BD%22%2C%22short_name%22%3A%22%E6%A6%82%E8%A6%BD%22%2C%22description%22%3A%22%E6%9F%A5%E7%9C%8B%E7%95%B6%E5%89%8D%E9%A4%98%E9%A1%8D%E5%92%8C%E4%BD%BF%E7%94%A8%E7%99%BE%E5%88%86%E6%AF%94%22%2C%22url%22%3A%22%3Fmode%3Dwidget%22%2C%22icons%22%3A%5B%7B%22src%22%3A%22data%3Aimage/svg%2Bxml%3Bbase64%2CPHN2ZyB3aWR0aD0iNDgiIGhlaWdodD0iNDgiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cGF0aCBkPSJNMjEgMTJWN0g1YTIgMiAwIDAgMSAwLTRoMTR2NCIgc3Ryb2tlPSIjMzQ5N0Y2IiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIvPjxwYXRoIGQ9Ik0zIDV2MTRhMiAyIDAgMCAwIDIgMmgxNnYtNSIgc3Ryb2tlPSIjMzQ5N0Y2IiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIvPjxjaXJjbGUgY3g9IjE4IiBjeT0iMTIiIHI9IjIiIGZpbGw9IiMzNDk3RjYiLz48L3N2Zz4%3D%22%2C%22sizes%22%3A%2248x48%22%2C%22type%22%3A%22image/svg%2Bxml%22%7D%5D%7D%2C%7B%22name%22%3A%22%E2%9E%95%20%E5%BF%AB%E9%80%9F%E8%A8%98%E5%B8%B3%22%2C%22short_name%22%3A%22%E8%A8%98%E5%B8%B3%22%2C%22description%22%3A%22%E5%BF%AB%E9%80%9F%E6%96%B0%E5%A2%9E%E6%94%AF%E5%87%BA%E9%A0%85%E7%9B%AE%22%2C%22url%22%3A%22%3Fmode%3Dquick%22%2C%22icons%22%3A%5B%7B%22src%22%3A%22data%3Aimage/svg%2Bxml%3Bbase64%2CPHN2ZyB3aWR0aD0iNDgiIGhlaWdodD0iNDgiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cGF0aCBkPSJNMTIgNXYxNG0tNy03aDE0IiBzdHJva2U9IiMzNDk3RjYiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIi8%2BPGNpcmNsZSBjeD0iMTIiIGN5PSIxMiIgcj0iMTAiIHN0cm9rZT0iIzM0OTdGNiIgc3Ryb2tlLXdpZHRoPSIyIiBmaWxsPSJub25lIi8%2BPC9zdmc%2B%22%2C%22sizes%22%3A%2248x48%22%2C%22type%22%3A%22image/svg%2Bxml%22%7D%5D%7D%5D%2C%22icons%22%3A%5B%7B%22src%22%3A%22data%3Aimage/svg%2Bxml%3Bbase64%2CPHN2ZyB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxyZWN0IHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgcng9IjQiIGZpbGw9IiUyMzM0OTdGNiIvPjxwYXRoIGQ9Ik0xNy41IDEyVjhoLTlhMS41IDEuNSAwIDAgMSAwLTNoOXYzIiBzdHJva2U9IndoaXRlIiBzdHJva2Utd2lkdGg9IjEuNSIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIi8%2BPHBhdGggZD0iTTYgNnYxMGExLjUgMS41IDAgMCAwIDEuNSAxLjVIMTlWMTUiIHN0cm9rZT0id2hpdGUiIHN0cm9rZS13aWR0aD0iMS41IiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiLz48Y2lyY2xlIGN4PSIxNSIgY3k9IjEyIiByPSIxIiBmaWxsPSJ3aGl0ZSIvPjwvc3ZnPg%3D%3D%22%2C%22sizes%22%3A%22192x192%22%2C%22type%22%3A%22image/svg%2Bxml%22%7D%5D%7D">
    
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        body { margin: 0; padding: 0; font-family: system-ui, sans-serif; }
        
        /* Widgetæ¨¡å¼æ¨£å¼ - 5x2æ©«å‘ä½ˆå±€ */
        .widget-mode {
            background: #f5f5f5;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .widget-card {
            background: #ffffff;
            border: 2px solid #000000;
            border-radius: 8px;
            padding: 16px;
            width: 100%;
            max-width: 400px;
            height: 160px;
            box-shadow: 2px 2px 8px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            position: relative;
        }
        
        .widget-header {
            display: none; /* ç§»é™¤å–®ç¨çš„$ç¬¦è™Ÿ */
        }
        
        .widget-balance {
            font-size: 3rem; /* åŠ å¤§æ•¸å­— */
            font-weight: bold;
            color: #000000;
            margin: 0;
            line-height: 1;
            display: flex;
            align-items: baseline;
        }
        
        .widget-currency {
            font-size: 2rem; /* $ç¬¦è™Ÿç¨å°ä¸€é» */
            margin-right: 4px;
        }
        
        .widget-label {
            color: #000000;
            font-size: 1rem;
            font-weight: normal;
        }
        
        .widget-progress-container {
            margin-top: 12px;
            width: 100%;
        }
        
        .widget-progress-bar {
            width: 100%;
            height: 20px;
            background: #e5e7eb;
            border: 2px solid #000000;
            border-radius: 4px;
            overflow: hidden;
            margin: 8px 0;
        }
        
        .widget-progress-fill {
            height: 100%;
            background: #3b82f6;
            border-radius: 0;
            transition: width 0.6s ease;
        }
        
        .widget-percentage {
            font-size: 1.25rem;
            font-weight: bold;
            color: #3b82f6;
            margin-bottom: 4px;
        }
        
        .widget-left-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding-right: 20px;
        }
        
        .widget-right-section {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .widget-add-button {
            width: 60px;
            height: 60px;
            background: #ffffff;
            border: 2px solid #ff4444;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .widget-add-button:hover {
            background: #ff4444;
            color: white;
        }
        
        .widget-add-button .plus-icon {
            font-size: 2rem;
            font-weight: bold;
            color: #ff4444;
        }
        
        .widget-add-button:hover .plus-icon {
            color: white;
        }
        
        .widget-actions {
            display: none; /* éš±è—åŸæœ‰çš„æ“ä½œæŒ‰éˆ• */
        }
        
        .widget-button {
            display: none; /* éš±è—åŸæœ‰çš„æŒ‰éˆ•æ¨£å¼ */
        }
        
        .quick-add-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .quick-add-modal.show {
            opacity: 1;
            visibility: visible;
        }
        
        .quick-add-content {
            background: white;
            border-radius: 20px;
            padding: 24px;
            width: 90%;
            max-width: 400px;
            transform: scale(0.8);
            transition: transform 0.3s ease;
        }
        
        .quick-add-modal.show .quick-add-content {
            transform: scale(1);
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <!-- å¿«é€Ÿæ·»åŠ æ¨¡æ…‹æ¡† -->
    <div id="quick-add-modal" class="quick-add-modal">
        <div class="quick-add-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin: 0; font-size: 18px; font-weight: bold;">ğŸ’° å¿«é€Ÿè¨˜å¸³</h3>
                <button onclick="closeQuickAdd()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #6b7280;">Ã—</button>
            </div>
            
            <div style="display: grid; gap: 16px;">
                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 12px;">
                    <input id="quick-amount" type="number" placeholder="é‡‘é¡" style="padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 16px;">
                    <select id="quick-category" style="padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 16px;">
                        <option value="é¤é£²">é¤é£²</option>
                        <option value="äº¤é€š">äº¤é€š</option>
                        <option value="ä½å®¿">ä½å®¿</option>
                        <option value="è³¼ç‰©">è³¼ç‰©</option>
                        <option value="å¨›æ¨‚">å¨›æ¨‚</option>
                        <option value="å…¶ä»–">å…¶ä»–</option>
                    </select>
                </div>
                
                <input id="quick-description" type="text" placeholder="æ”¯å‡ºæè¿° (å¯é¸)" style="padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 16px;">
                
                <button onclick="submitQuickAdd()" class="widget-button widget-button-primary" style="padding: 16px; font-size: 16px;">
                    <span>âœ… æ–°å¢æ”¯å‡º</span>
                </button>
            </div>
            
            <div id="quick-status" style="margin-top: 12px; text-align: center; font-size: 14px;"></div>
        </div>
    </div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        
        function TravelBudgetApp() {
            const urlParams = new URLSearchParams(window.location.search);
            const mode = urlParams.get('mode');
            
            const [totalBudget, setTotalBudget] = useState(() => {
                try {
                    const saved = localStorage.getItem('travelBudgetData');
                    return saved ? JSON.parse(saved).totalBudget || 0 : 0;
                } catch { return 0; }
            });
            
            const [expenses, setExpenses] = useState(() => {
                try {
                    const saved = localStorage.getItem('travelBudgetData');
                    return saved ? JSON.parse(saved).expenses || [] : [];
                } catch { return []; }
            });

            // è‡ªå‹•ä¿å­˜
            useEffect(() => {
                const data = { totalBudget, expenses, lastSaved: new Date().toISOString() };
                localStorage.setItem('travelBudgetData', JSON.stringify(data));
            }, [totalBudget, expenses]);
            
            const totalSpent = expenses.reduce((sum, expense) => sum + expense.amount, 0);
            const remainingBudget = totalBudget - totalSpent;
            const budgetUsedPercentage = totalBudget > 0 ? (totalSpent / totalBudget) * 100 : 0;
            
            const addExpense = (expenseData) => {
                const expense = {
                    id: Date.now(),
                    description: expenseData.description || `${expenseData.category}æ”¯å‡º`,
                    amount: parseFloat(expenseData.amount),
                    category: expenseData.category,
                    date: new Date().toLocaleDateString('zh-TW')
                };
                setExpenses([...expenses, expense]);
            };

            // æš´éœ²å‡½æ•¸åˆ°å…¨åŸŸ
            useEffect(() => {
                window.addExpenseFromQuick = addExpense;
            }, [expenses]);

            // Widgetæ¨¡å¼ - 5x2æ©«å‘ä½ˆå±€
            if (mode === 'widget') {
                return (
                    <div className="widget-mode">
                        <div className="widget-card">
                            {/* å·¦å´å…§å®¹å€åŸŸ */}
                            <div className="widget-left-section">
                                {totalBudget > 0 ? (
                                    <>
                                        {/* é¤˜é¡é¡¯ç¤º(åŒ…å«$ç¬¦è™Ÿ) */}
                                        <div className="widget-balance" style={{
                                            color: budgetUsedPercentage >= 90 ? '#ef4444' : 
                                                   budgetUsedPercentage >= 75 ? '#eab308' : '#000000'
                                        }}>
                                            <span className="widget-currency">$</span>
                                            <span>
                                                {remainingBudget >= 0 ? 
                                                    `${Math.abs(remainingBudget).toLocaleString()}` : 
                                                    `-${Math.abs(remainingBudget).toLocaleString()}`}
                                            </span>
                                        </div>
                                        
                                        {/* ç™¾åˆ†æ¯” */}
                                        <div className="widget-percentage" style={{
                                            color: budgetUsedPercentage >= 90 ? '#ef4444' : 
                                                   budgetUsedPercentage >= 75 ? '#eab308' : '#3b82f6'
                                        }}>
                                            {budgetUsedPercentage.toFixed(0)}%
                                        </div>
                                        
                                        {/* é€²åº¦æ¢ */}
                                        <div className="widget-progress-container">
                                            <div className="widget-progress-bar">
                                                <div 
                                                    className="widget-progress-fill"
                                                    style={{
                                                        width: `${Math.min(budgetUsedPercentage, 100)}%`,
                                                        background: budgetUsedPercentage >= 90 ? '#ef4444' : 
                                                                   budgetUsedPercentage >= 75 ? '#eab308' : '#3b82f6'
                                                    }}
                                                />
                                            </div>
                                        </div>
                                    </>
                                ) : (
                                    <div>
                                        <div className="widget-balance">
                                            <span className="widget-currency">$</span>
                                            <span>0</span>
                                        </div>
                                        <div className="widget-percentage">è¨­å®šé ç®—</div>
                                    </div>
                                )}
                            </div>
                            
                            {/* å³å´æ·»åŠ æŒ‰éˆ• */}
                            <div className="widget-right-section">
                                <div 
                                    className="widget-add-button"
                                    onClick={() => totalBudget > 0 ? window.openQuickAdd() : window.location.href = '.'}
                                >
                                    <span className="plus-icon">+</span>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            // å®Œæ•´Appæ¨¡å¼ (ä¿æŒåŸæœ‰åŠŸèƒ½)
            return (
                <div className="max-w-md mx-auto bg-white min-h-screen">
                    <div className="bg-gradient-to-r from-blue-500 to-purple-600 text-white p-6">
                        <div className="flex items-center gap-3 mb-2">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                <path d="M21 12V7H5a2 2 0 0 1 0-4h14v4"/>
                                <path d="M3 5v14a2 2 0 0 0 2 2h16v-5"/>
                                <circle cx="18" cy="12" r="2"/>
                            </svg>
                            <h1 className="text-xl font-bold">æ—…éŠé ç®—ç®¡ç†</h1>
                        </div>
                        <p className="text-blue-100 text-sm">æ™ºæ…§ç®¡ç†ä½ çš„æ—…éŠæ”¯å‡º ğŸ’°</p>
                    </div>

                    <div className="p-4 space-y-6">
                        <div className="bg-gray-50 rounded-xl p-4">
                            <label className="block text-sm font-medium text-gray-700 mb-2">
                                ğŸ’³ è¨­å®šç¸½é ç®— (æ–°å°å¹£)
                            </label>
                            <input
                                type="number"
                                value={totalBudget || ''}
                                onChange={(e) => setTotalBudget(parseFloat(e.target.value) || 0)}
                                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 text-lg"
                                placeholder="è¼¸å…¥ä½ çš„ç¸½é ç®—"
                            />
                        </div>

                        {totalBudget > 0 && (
                            <div className="bg-gradient-to-br from-blue-50 to-purple-50 border border-blue-200 rounded-xl p-4">
                                <h3 className="font-bold text-gray-800 mb-3">ğŸ“Š é ç®—ç¸½è¦½</h3>
                                
                                <div className="grid grid-cols-2 gap-4 mb-4">
                                    <div className="text-center">
                                        <div className="text-lg font-bold text-green-600">
                                            NT${remainingBudget.toLocaleString()}
                                        </div>
                                        <div className="text-xs text-gray-500">å‰©é¤˜é ç®—</div>
                                    </div>
                                    
                                    <div className="text-center">
                                        <div className="text-lg font-bold text-red-600">
                                            NT${totalSpent.toLocaleString()}
                                        </div>
                                        <div className="text-xs text-gray-500">å·²æ”¯å‡º</div>
                                    </div>
                                </div>
                                
                                <div className="w-full bg-gray-200 rounded-full h-3">
                                    <div 
                                        className={`h-3 rounded-full transition-all duration-500 ${
                                            budgetUsedPercentage >= 90 ? 'bg-red-500' : 
                                            budgetUsedPercentage >= 75 ? 'bg-yellow-500' : 'bg-green-500'
                                        }`}
                                        style={{ width: `${Math.min(budgetUsedPercentage, 100)}%` }}
                                    />
                                </div>
                                
                                <div className="text-center text-sm text-gray-600 mt-2">
                                    ä½¿ç”¨ç‡ {budgetUsedPercentage.toFixed(1)}%
                                </div>
                            </div>
                        )}

                        <div className="text-center">
                            <button
                                onClick={() => window.openQuickAdd()}
                                className="bg-gradient-to-r from-blue-500 to-purple-600 text-white px-8 py-4 rounded-xl hover:from-blue-600 hover:to-purple-700 transition-all flex items-center gap-3 mx-auto text-lg font-medium"
                            >
                                <span>â•</span>
                                <span>å¿«é€Ÿè¨˜å¸³</span>
                            </button>
                        </div>

                        {expenses.length > 0 && (
                            <div className="space-y-2">
                                <h3 className="font-semibold text-gray-800">ğŸ“ æœ€è¿‘æ”¯å‡º</h3>
                                {expenses.slice().reverse().slice(0, 5).map(expense => (
                                    <div key={expense.id} className="bg-white border border-gray-200 rounded-lg p-3">
                                        <div className="flex justify-between items-start">
                                            <div className="flex-1">
                                                <div className="font-medium text-gray-800">{expense.description}</div>
                                                <div className="text-sm text-gray-500">{expense.category} â€¢ {expense.date}</div>
                                            </div>
                                            <div className="font-bold text-red-600">
                                                -NT${expense.amount.toLocaleString()}
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        ReactDOM.render(<TravelBudgetApp />, document.getElementById('root'));
    </script>

    <script>
        // WidgetåŠŸèƒ½
        window.openQuickAdd = function() {
            document.getElementById('quick-add-modal').classList.add('show');
            setTimeout(() => {
                document.getElementById('quick-amount').focus();
            }, 300);
        };

        window.closeQuickAdd = function() {
            document.getElementById('quick-add-modal').classList.remove('show');
        };

        window.submitQuickAdd = function() {
            const amount = document.getElementById('quick-amount').value;
            const category = document.getElementById('quick-category').value;
            const description = document.getElementById('quick-description').value;
            const status = document.getElementById('quick-status');
            
            if (!amount) {
                status.innerHTML = '<span style="color: red;">è«‹è¼¸å…¥é‡‘é¡</span>';
                return;
            }
            
            if (window.addExpenseFromQuick) {
                window.addExpenseFromQuick({
                    amount: amount,
                    category: category,
                    description: description || `${category}æ”¯å‡º`
                });
                
                // æ¸…ç©ºè¡¨å–®
                document.getElementById('quick-amount').value = '';
                document.getElementById('quick-description').value = '';
                
                status.innerHTML = '<span style="color: green;">âœ… è¨˜å¸³æˆåŠŸï¼</span>';
                
                setTimeout(() => {
                    window.closeQuickAdd();
                    status.innerHTML = '';
                }, 1500);
            }
        };

        // éµç›¤å¿«æ·éµ
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                window.closeQuickAdd();
            }
        });

        // é»æ“Šå¤–éƒ¨é—œé–‰
        document.getElementById('quick-add-modal').addEventListener('click', (e) => {
            if (e.target === e.currentTarget) {
                window.closeQuickAdd();
            }
        });
    </script>
</body>
</html>
